<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WaveMeet - Video Conference</title>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Jitsi Meet API library -->
  <script src="https://8x8.vc/vpaas-magic-cookie-487dd6b9c61b44088ba164129a3bd317/external_api.js"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --secondary: #10b981;
      --secondary-light: #34d399;
      --dark: #1e1e2e;
      --dark-light: #292942;
      --dark-lighter: #313151;
      --light: #f8fafc;
      --light-dark: #e2e8f0;
      --danger: #ef4444;
      --danger-light: #f87171;
      --warning: #f59e0b;
      --primary-transparent: rgba(99, 102, 241, 0.2);
      --dark-transparent: rgba(30, 30, 46, 0.85);
      --transition: all 0.3s ease;
      --glass-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.15);
      --glass-border: 1px solid rgba(255, 255, 255, 0.08);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 24px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    
    body {
      background-color: var(--dark);
      color: var(--light);
      transition: var(--transition);
      font-size: 14px;
      line-height: 1.5;
    }
    
    .meeting-container {
      display: flex;
      height: 100vh;
      position: relative;
    }
    
    /* Video Grid */
    .video-grid-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: var(--spacing-lg);
      overflow: hidden;
      position: relative;
      gap: var(--spacing-md);
    }
    
    .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      grid-auto-rows: 1fr;
      gap: var(--spacing-lg);
      overflow: auto;
      padding-right: var(--spacing-md);
      position: relative;
      border-radius: var(--radius-md);
    }
    
    .video-grid::-webkit-scrollbar {
      width: 5px;
    }
    
    .video-grid::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }
    
    .video-tile {
      position: relative;
      border-radius: var(--radius-md);
      overflow: hidden;
      aspect-ratio: 16/9;
      background-color: var(--dark-lighter);
      box-shadow: var(--glass-shadow);
    }
    
    .video-wrapper {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .video-feed {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .video-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--spacing-lg);
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
      display: flex;
      justify-content: space-between;
      align-items: center;
      opacity: 0;
      transition: var(--transition);
    }
    
    .video-tile:hover .video-overlay {
      opacity: 1;
    }
    
    .user-info {
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .user-controls {
      display: flex;
      gap: var(--spacing-sm);
    }
    
    .status-icon {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 50%;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .status-icon:hover {
      background-color: var(--primary-transparent);
    }
    
    /* Meeting Info Bar */
    .meeting-info-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg) var(--spacing-xl);
      background: var(--dark-transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--radius-lg);
      box-shadow: var(--glass-shadow);
      border: var(--glass-border);
    }
    
    .meeting-details {
      display: flex;
      align-items: center;
      gap: var(--spacing-xl);
    }
    
    .meeting-id {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-lg);
      background: rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .meeting-id:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }
    
    .meeting-timer {
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .meeting-timer i {
      color: var(--primary-light);
    }
    
    .view-controls {
      display: flex;
      align-items: center;
      gap: var(--spacing-lg);
    }
    
    /* Meeting Controls */
    .invite-button-container {
      display: flex;
      justify-content: center;
      margin-bottom: var(--spacing-md);
    }
    
    .meeting-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg) var(--spacing-xl);
      background: var(--dark-transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--radius-lg);
      box-shadow: var(--glass-shadow);
      border: var(--glass-border);
      z-index: 100;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: var(--spacing-lg);
    }
    
    .control-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 52px;
      height: 52px;
      border-radius: var(--radius-lg);
      background: rgba(255, 255, 255, 0.08);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      border: none;
      color: var(--light);
    }
    
    .control-btn.active {
      background: var(--primary-transparent);
      color: var(--primary-light);
    }
    
    .control-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .control-btn.danger {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger-light);
    }
    
    .control-btn.danger:hover {
      background: rgba(239, 68, 68, 0.3);
    }
    
    .control-btn i {
      font-size: 18px;
      margin-bottom: var(--spacing-xs);
    }
    
    .control-label {
      font-size: 10px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0.9;
    }
    
    .control-dropdown {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: var(--spacing-sm);
      background: var(--dark-transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--radius-md);
      box-shadow: var(--glass-shadow);
      border: var(--glass-border);
      padding: var(--spacing-sm) 0;
      min-width: 180px;
      visibility: hidden;
      opacity: 0;
      transition: var(--transition);
      z-index: 100;
    }
    
    .control-btn:focus .control-dropdown,
    .control-btn:hover .control-dropdown {
      visibility: visible;
      opacity: 1;
      transform: translateX(-50%) translateY(-5px);
    }
    
    .dropdown-item {
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }
    
    .dropdown-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--primary-light);
    }
    
    .dropdown-item i {
      font-size: 14px;
      margin: 0;
    }
    
    .network-quality {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 20px;
      padding: 0 var(--spacing-sm);
    }
    
    .quality-indicator {
      width: 4px;
      height: 8px;
      border-radius: 1px;
      background: rgba(255, 255, 255, 0.15);
      transition: var(--transition);
    }
    
    .quality-indicator:nth-child(2) {
      height: 12px;
    }
    
    .quality-indicator:nth-child(3) {
      height: 16px;
    }
    
    .quality-indicator:nth-child(4) {
      height: 20px;
    }
    
    .quality-indicator.active {
      background: var(--secondary);
    }
    
    /* Side Panels */
    .side-panel {
      width: 0;
      height: 80%;
      background: var(--dark-transparent);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: var(--glass-shadow);
      border-left: var(--glass-border);
      position: absolute;
      right: 0;
      top: 0;
      z-index: 10;
      overflow: hidden;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
    }
    
    .side-panel.active {
      width: 340px;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg) var(--spacing-xl);
      border-bottom: var(--glass-border);
    }
    
    .panel-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary-light);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .panel-title i {
      font-size: 14px;
    }
    
    .panel-close {
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
      color: var(--light-dark);
    }
    
    .panel-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--light);
    }
    
    .search-input {
      width: 100%;
      padding: var(--spacing-md) var(--spacing-lg);
      border: var(--glass-border);
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.05);
      color: var(--light);
      font-size: 14px;
      outline: none;
      transition: var(--transition);
    }
    
    .search-input:focus {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.2);
    }
    
    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--danger);
      color: var(--light);
      font-size: 10px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--dark);
    }
    
    #jitsi-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    .jitsi-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .panel-content {
      padding: var(--spacing-lg);
    }
    
    #participants-list {
      margin-top: var(--spacing-lg);
    }
    
    #participants-list > div {
      padding: var(--spacing-lg);
      border-radius: var(--radius-md);
      transition: var(--transition);
      margin-bottom: var(--spacing-sm);
      background: rgba(255, 255, 255, 0.03);
    }
    
    #participants-list > div:hover {
      background: rgba(255, 255, 255, 0.06);
    }
    
    #chat-messages {
      padding: var(--spacing-lg);
    }
    
    #chat-messages > div {
      margin-bottom: var(--spacing-lg);
      max-width: 85%;
    }
    
    #chat-messages span {
      display: inline-block;
    }
    
    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--dark);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      gap: var(--spacing-xl);
    }
    
    .loader {
      width: 48px;
      height: 48px;
      border: 4px solid var(--primary-transparent);
      border-bottom-color: var(--primary);
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }
    
    .loading-text {
      font-size: 18px;
      font-weight: 500;
      color: var(--primary-light);
      animation: pulse 2s infinite;
    }
    
    @keyframes rotation {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    .hidden {
      display: none;
    }
    
    #record-btn {
      display: none; /* Hide record button as recording is not supported on public server */
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--dark-transparent);
      color: var(--light);
      padding: var(--spacing-md) var(--spacing-xl);
      border-radius: var(--radius-md);
      box-shadow: var(--glass-shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-left: 3px solid var(--primary);
      z-index: 10000;
      max-width: 300px;
      transition: all 0.5s ease;
    }
    
    /* For mobile devices */
    @media (max-width: 768px) {
      .video-grid-container {
        padding: var(--spacing-md);
      }
      
      .meeting-info-bar {
        flex-direction: column;
        gap: var(--spacing-md);
        align-items: flex-start;
        padding: var(--spacing-md);
      }
      
      .meeting-details {
        width: 100%;
        justify-content: space-between;
      }
      
      .view-controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .control-group {
        gap: var(--spacing-sm);
      }
      
      .control-btn {
        width: 44px;
        height: 44px;
      }
      
      .side-panel.active {
        width: 100%;
      }
      
      .meeting-controls {
        padding: var(--spacing-md);
      }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading-overlay">
    <span class="loader"></span>
    <div class="loading-text">Connecting to WaveMeet...</div>
  </div>

  <div class="meeting-container">
    <div class="video-grid-container">
      <!-- Meeting Info Bar -->
      <div class="meeting-info-bar">
        <div class="meeting-details">
          <div class="meeting-id" id="meeting-id-display" onclick="copyMeetingId()">
            <i class="fas fa-qrcode"></i>
            <span id="room-id">Loading...</span>
          </div>
          <div class="meeting-timer">
            <i class="fas fa-clock"></i>
            <span id="meeting-timer-display">00:00:00</span>
          </div>
        </div>
        <div class="view-controls">
          <!-- Placeholder for future view controls -->
        </div>
      </div>

      <!-- Video Grid -->
      <div class="video-grid">
        <!-- Jitsi Container -->
        <div id="jitsi-container"></div>
      </div>
      
      <div class="invite-button-container">
        <button class="control-btn" onclick="copyInviteLink()" title="Copy Invite Link">
          <i class="fas fa-user-plus"></i>
          <span class="control-label">Invite</span>
        </button>
      </div>
      
      <!-- Meeting Controls -->
      <div class="meeting-controls">
        <div class="control-group">
          <div class="network-quality">
            <div class="quality-indicator active"></div>
            <div class="quality-indicator active"></div>
            <div class="quality-indicator active"></div>
            <div class="quality-indicator"></div>
          </div>
        </div>

        <div class="control-group">
          <!-- Mic Control -->
          <div class="control-btn active" id="mute-btn" onclick="toggleMute()">
            <i class="fas fa-microphone" id="mute-icon"></i>
            <span class="control-label">Mute</span>
          </div>

          <!-- Camera Control -->
          <div class="control-btn active" id="camera-btn" onclick="toggleCamera()">
            <i class="fas fa-video" id="camera-icon"></i>
            <span class="control-label">Camera</span>
          </div>
          
          <!-- Screen Share -->
          <div class="control-btn" id="share-btn" onclick="toggleScreenShare()">
            <i class="fas fa-desktop" id="share-icon"></i>
            <span class="control-label">Share</span>
          </div>
          
          <!-- Record -->
          <div class="control-btn" id="record-btn" onclick="toggleRecord()">
            <i class="fas fa-circle-dot" id="record-icon"></i>
            <span class="control-label">Record</span>
          </div>
          
          <!-- Reactions -->
          <div class="control-btn" id="reactions-btn">
            <i class="fas fa-smile"></i>
            <span class="control-label">Reactions</span>
            <div class="control-dropdown">
              <div class="dropdown-item" onclick="sendReaction('thumbsUp')"><i class="fas fa-thumbs-up"></i> Thumbs Up</div>
              <div class="dropdown-item" onclick="sendReaction('clap')"><i class="fas fa-hands-clap"></i> Clap</div>
              <div class="dropdown-item" onclick="sendReaction('heart')"><i class="fas fa-heart"></i> Heart</div>
              <div class="dropdown-item" onclick="sendReaction('laugh')"><i class="fas fa-laugh"></i> Laugh</div>
              <div class="dropdown-item" onclick="sendReaction('surprise')"><i class="fas fa-surprise"></i> Surprised</div>
              <div class="dropdown-item" onclick="raiseHand()">
                <i class="fas fa-hand-point-up"></i> Raise Hand
              </div>
            </div>
          </div>
          
          <!-- More Controls -->
          <div class="control-btn">
            <i class="fas fa-ellipsis-h"></i>
            <span class="control-label">More</span>
            <div class="control-dropdown">
              <div class="dropdown-item" onclick="toggleSettings()">
                <i class="fas fa-cog"></i> Settings
              </div>
              <div class="dropdown-item" onclick="copyInviteLink()">
                <i class="fas fa-user-plus"></i> Invite
              </div>
            </div>
          </div>
        </div>

        <div class="control-group">
          <!-- Participants -->
          <div class="control-btn" onclick="togglePanel('participants-panel')">
            <i class="fas fa-users"></i>
            <span class="control-label">People</span>
            <div class="notification-badge" id="participants-count">0</div>
          </div>
          
          <!-- Chat -->
          <div class="control-btn" onclick="togglePanel('chat-panel')">
            <i class="fas fa-comment"></i>
            <span class="control-label">Chat</span>
            <div class="notification-badge" id="unread-count">0</div>
          </div>
          
          <!-- Leave Meeting -->
          <div class="control-btn danger" onclick="hangup()">
            <i class="fas fa-sign-out-alt"></i>
            <span class="control-label">Leave</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Participants Panel -->
    <div class="side-panel" id="participants-panel">
      <div class="panel-header">
        <div class="panel-title">
          <i class="fas fa-users"></i>
          Participants
        </div>
        <div class="panel-close" onclick="togglePanel('participants-panel')">
          <i class="fas fa-times"></i>
        </div>
      </div>
      <div class="panel-content">
        <input type="search" id="search-participants" class="search-input" placeholder="Search participants...">
        <div id="participants-list"></div>
      </div>
    </div>
    
    <!-- Chat Panel -->
    <div class="side-panel" id="chat-panel">
      <div class="panel-header">
        <div class="panel-title">
          <i class="fas fa-comment"></i>
          Chat
        </div>
        <div class="panel-close" onclick="togglePanel('chat-panel')">
          <i class="fas fa-times"></i>
        </div>
      </div>
      <div class="panel-content" style="display: flex; flex-direction: column; height: 100%;">
        <div id="chat-messages" style="flex: 1; overflow-y: auto;"></div>
        <div style="padding: var(--spacing-md); border-top: var(--glass-border);">
          <input type="text" id="chat-input" class="search-input" placeholder="Type a message..." style="width: 100%;" onkeypress="if(event.key === 'Enter') sendMessage()">
        </div>
      </div>
    </div>
  </div>

  <script>
   // DOM Elements
const jitsiContainer = document.getElementById('jitsi-container');
const roomIdDisplay = document.getElementById('room-id');
const participantsCount = document.getElementById('participants-count');
const participantsList = document.getElementById('participants-list');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const unreadCount = document.getElementById('unread-count');
const loadingOverlay = document.getElementById('loading-overlay');
const muteBtn = document.getElementById('mute-btn');
const muteIcon = document.getElementById('mute-icon');
const cameraBtn = document.getElementById('camera-btn');
const cameraIcon = document.getElementById('camera-icon');
const shareBtn = document.getElementById('share-btn');
const shareIcon = document.getElementById('share-icon');
const recordBtn = document.getElementById('record-btn');
const recordIcon = document.getElementById('record-icon');
const timerDisplay = document.getElementById('meeting-timer-display');
const searchParticipants = document.getElementById('search-participants');

// Jitsi API
let api = null;
let roomName = '';
let displayName = '';
let userEmail = '';
let avatarUrl = '';
let isMuted = false;
let isVideoEnabled = true;
let isScreenSharingEnabled = false;
let isRecording = false;
let isHandRaised = false;
let meetingStartTime = null;
let timerInterval = null;
let unreadMessages = 0;
let participantsData = [];
let chatIsOpen = false;

// Get URL Parameters
const urlParams = new URLSearchParams(window.location.search);
roomName = urlParams.get('room') || '';
displayName = urlParams.get('name') || 'Guest ' + Math.floor(Math.random() * 1000);
userEmail = urlParams.get('email') || '';
avatarUrl = urlParams.get('avatar') || '';

const startWithAudioMuted = urlParams.get('audio') === 'false';
const startWithVideoMuted = urlParams.get('video') === 'false';

// Validate URL Parameters
if (!roomName || !displayName) {
  alert('Invalid or missing parameters. Please start or join a meeting from the home page.');
  window.location.href = 'index.html';
}

// Display Room ID
roomIdDisplay.textContent = 'WM-' + roomName;

// Initialize Timer
function startTimer() {
  meetingStartTime = new Date();
  timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
  if (!meetingStartTime) return;
  
  const now = new Date();
  const diff = now - meetingStartTime;
  
  const hours = Math.floor(diff / 3600000).toString().padStart(2, '0');
  const minutes = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
  const seconds = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
  
  timerDisplay.textContent = `${hours}:${minutes}:${seconds}`;
}

// Generate Unique Room ID
function generateRoomId() {
  const timestamp = Date.now().toString(36);
  const randomStr = Math.random().toString(36).substring(2, 8);
  return timestamp.substring(timestamp.length - 4) + randomStr.substring(0, 4);
}

// Initialize 8x8 Jitsi Meet
function initJitsi() {
  const domain = '8x8.vc';
  const appId = 'vpaas-magic-cookie-487dd6b9c61b44088ba164129a3bd317';
  const fullRoomName = `${appId}/${roomName}`;
  
  const options = {
    roomName: fullRoomName,
    parentNode: jitsiContainer,
    userInfo: {
      displayName: displayName,
      email: userEmail,
      avatarURL: avatarUrl,
    },
    // Uncomment and replace with your JWT if needed for premium features
    // jwt: 'your-jwt-token-here',
    configOverwrite: {
      prejoinPageEnabled: false,
      disableDeepLinking: true,
      startWithAudioMuted: startWithAudioMuted,
      startWithVideoMuted: startWithVideoMuted,
      startScreenSharing: false,
      enableWelcomePage: false,
      enableClosePage: false,
      disableThirdPartyRequests: true,
      hideConferenceSubject: true,
      hideConferenceTimer: true,
      disableInviteFunctions: false,
      recordingType: 'jibri',
    },
    interfaceConfigOverwrite: {
      TOOLBAR_BUTTONS: [],
      SHOW_JITSI_WATERMARK: false,
      SHOW_WATERMARK_FOR_GUESTS: false,
      SHOW_BRAND_WATERMARK: false,
      SHOW_POWERED_BY: false,
      SHOW_CHROME_EXTENSION_BANNER: false,
      DISPLAY_WELCOME_PAGE_CONTENT: false,
      DISPLAY_WELCOME_PAGE_TOOLBAR_ADDITIONAL_CONTENT: false,
      HIDE_INVITE_MORE_HEADER: true,
      MOBILE_APP_PROMO: false,
      NATIVE_APP_NAME: 'WaveMeet',
      PROVIDER_NAME: 'WaveMeet',
      INVITATION_POWERED_BY: false,
    },
  };

  try {
    api = new JitsiMeetExternalAPI(domain, options);
    
    api.on('videoConferenceJoined', handleVideoConferenceJoined);
    api.on('participantJoined', handleParticipantJoined);
    api.on('participantLeft', handleParticipantLeft);
    api.on('audioMuteStatusChanged', handleAudioMuteStatusChanged);
    api.on('videoMuteStatusChanged', handleVideoMuteStatusChanged);
    api.on('screenSharingStatusChanged', handleScreenSharingStatusChanged);
    api.on('recordingStatusChanged', handleRecordingStatusChanged);
    api.on('raiseHandUpdated', handleRaiseHandUpdated);
    api.on('incomingMessage', handleIncomingMessage);
    api.on('outgoingMessage', handleOutgoingMessage);
    api.on('readyToClose', handleReadyToClose);
    api.on('participantRoleChanged', handleParticipantRoleChanged);
    api.on('participantKickedOut', handleParticipantKickedOut);
    api.on('subjectChange', handleSubjectChange);
    api.on('videoQualityChanged', handleVideoQualityChanged);
    api.on('deviceListChanged', handleDeviceListChanged);
    
    setTimeout(() => {
      loadingOverlay.classList.add('hidden');
    }, 2000);
    
  } catch (error) {
    console.error("Error initializing 8x8 Jitsi:", error);
    alert("Failed to connect to the meeting. Please try again.");
    window.location.href = 'index.html';
  }
}

// Event Handlers
function handleVideoConferenceJoined(event) {
  console.log("Joined conference:", event);
  startTimer();
  updateUIForAudioMute(startWithAudioMuted);
  updateUIForVideoMute(startWithVideoMuted);
  
  const userId = event.id;
  const participantInfo = {
    id: userId,
    displayName: displayName,
    isLocal: true,
  };
  
  participantsData.push(participantInfo);
  updateParticipantsList();
}

function handleParticipantJoined(event) {
  console.log("Participant joined:", event);
  
  const participantInfo = {
    id: event.id,
    displayName: event.displayName || 'Guest',
    isLocal: false,
  };
  
  participantsData.push(participantInfo);
  updateParticipantsList();
  
  showNotification(`${participantInfo.displayName} joined the meeting`);
}

function handleParticipantLeft(event) {
  console.log("Participant left:", event);
  
  const index = participantsData.findIndex(p => p.id === event.id);
  if (index !== -1) {
    const leftParticipant = participantsData[index];
    participantsData.splice(index, 1);
    updateParticipantsList();
    
    showNotification(`${leftParticipant.displayName} left the meeting`);
  }
}

function handleAudioMuteStatusChanged(event) {
  isMuted = event.muted;
  updateUIForAudioMute(isMuted);
}

function handleVideoMuteStatusChanged(event) {
  isVideoEnabled = !event.muted;
  updateUIForVideoMute(event.muted);
}

function handleScreenSharingStatusChanged(event) {
  isScreenSharingEnabled = event.on;
  updateUIForScreenSharing(isScreenSharingEnabled);
}

function handleRecordingStatusChanged(event) {
  isRecording = event.on;
  if (!isRecording && event.error) {
    showNotification('Recording failed: ' + event.error);
  }
  updateUIForRecording(isRecording);
}

function handleRaiseHandUpdated(event) {
  const participant = participantsData.find(p => p.id === event.id);
  if (participant) {
    participant.handRaised = event.handRaised;
    updateParticipantsList();
  }
}

function handleIncomingMessage(event) {
  console.log("Incoming message:", event);
  const senderName = event.nick || 'Someone';
  
  addMessageToChat(senderName, event.message, false);
  
  if (!chatIsOpen) {
    unreadMessages++;
    unreadCount.textContent = unreadMessages;
    unreadCount.classList.remove('hidden');
  }
}

function handleOutgoingMessage(event) {
  console.log("Outgoing message:", event);
  addMessageToChat(displayName, event.message, true);
}

function handleReadyToClose() {
  console.log("Meeting is about to close");
  clearInterval(timerInterval);
  window.location.href = 'index.html';
}

function handleParticipantRoleChanged(event) {
  console.log("Participant role changed:", event);
  const participant = participantsData.find(p => p.id === event.id);
  if (participant) {
    participant.role = event.role;
    updateParticipantsList();
  }
}

function handleParticipantKickedOut(event) {
  console.log("Participant kicked out:", event);
  if (event.kicked.id === api.getParticipantsInfo()[0].id) {
    showNotification("You have been removed from the meeting");
    setTimeout(() => {
      window.location.href = "index.html";
    }, 2000);
  }
}

function handleSubjectChange(event) {
  console.log("Subject changed:", event);
}

function handleVideoQualityChanged(event) {
  console.log("Video quality changed:", event);
  updateNetworkQualityIndicators(event.videoQuality);
}

function handleDeviceListChanged(event) {
  console.log("Device list changed:", event);
}

// UI Update Functions
function updateUIForAudioMute(muted) {
  if (muted) {
    muteBtn.classList.remove('active');
    muteIcon.classList.remove('fa-microphone');
    muteIcon.classList.add('fa-microphone-slash');
    muteBtn.querySelector('.control-label').textContent = 'Unmute';
  } else {
    muteBtn.classList.add('active');
    muteIcon.classList.remove('fa-microphone-slash');
    muteIcon.classList.add('fa-microphone');
    muteBtn.querySelector('.control-label').textContent = 'Mute';
  }
}

function updateUIForVideoMute(muted) {
  if (muted) {
    cameraBtn.classList.remove('active');
    cameraIcon.classList.remove('fa-video');
    cameraIcon.classList.add('fa-video-slash');
    cameraBtn.querySelector('.control-label').textContent = 'Start';
  } else {
    cameraBtn.classList.add('active');
    cameraIcon.classList.remove('fa-video-slash');
    cameraIcon.classList.add('fa-video');
    cameraBtn.querySelector('.control-label').textContent = 'Camera';
  }
}

function updateUIForScreenSharing(enabled) {
  if (enabled) {
    shareBtn.classList.add('active');
    shareBtn.querySelector('.control-label').textContent = 'Stop';
  } else {
    shareBtn.classList.remove('active');
    shareBtn.querySelector('.control-label').textContent = 'Share';
  }
}

function updateUIForRecording(recording) {
  if (recording) {
    recordBtn.classList.add('active');
    recordIcon.classList.add('fa-blink');
    recordBtn.querySelector('.control-label').textContent = 'Stop';
  } else {
    recordBtn.classList.remove('active');
    recordIcon.classList.remove('fa-blink');
    recordBtn.querySelector('.control-label').textContent = 'Record';
  }
}

function updateNetworkQualityIndicators(quality) {
  const indicators = document.querySelectorAll('.quality-indicator');
  indicators.forEach((indicator, index) => {
    if (index < quality) {
      indicator.classList.add('active');
    } else {
      indicator.classList.remove('active');
    }
  });
}

// Control Actions
function toggleMute() {
  api.executeCommand('toggleAudio');
}

function toggleCamera() {
  api.executeCommand('toggleVideo');
}

function toggleScreenShare() {
  api.executeCommand('toggleShareScreen');
}

function toggleRecord() {
  if (!isRecording) {
    api.executeCommand('startRecording', { mode: 'file' });
  } else {
    api.executeCommand('stopRecording', 'file');
  }
}

function sendReaction(reaction) {
  showNotification(`You reacted with: ${reaction}`);
}

function raiseHand() {
  isHandRaised = !isHandRaised;
  api.executeCommand('toggleRaiseHand');
}

function hangup() {
  if (confirm('Are you sure you want to leave the meeting?')) {
    api.executeCommand('hangup');
    window.location.href = 'index.html';
  }
}

function togglePanel(panelId) {
  const panel = document.getElementById(panelId);
  const isActive = panel.classList.contains('active');
  
  document.querySelectorAll('.side-panel').forEach(p => {
    p.classList.remove('active');
  });
  
  if (!isActive) {
    panel.classList.add('active');
    if (panelId === 'chat-panel') {
      chatIsOpen = true;
      unreadMessages = 0;
      unreadCount.textContent = '0';
      unreadCount.classList.add('hidden');
    }
  } else {
    if (panelId === 'chat-panel') {
      chatIsOpen = false;
    }
  }
}

function toggleSettings() {
  alert('Settings functionality is not implemented yet.');
}

function copyMeetingId() {
  const meetingId = 'WM-' + roomName;
  navigator.clipboard.writeText(meetingId).then(() => {
    showNotification('Meeting ID copied to clipboard');
  });
}

function copyInviteLink() {
  const inviteLink = `${window.location.origin}/meeting.html?room=${roomName}&name=${encodeURIComponent(displayName)}&video=${isVideoEnabled}&audio=${!isMuted}`;
  navigator.clipboard.writeText(inviteLink).then(() => {
    showNotification('Invite link copied to clipboard');
  }).catch(err => {
    console.error('Failed to copy invite link:', err);
    showNotification('Failed to copy invite link');
  });
}

function showNotification(message) {
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.textContent = message;
  notification.style.position = 'fixed';
  notification.style.top = '20px';
  notification.style.right = '20px';
  notification.style.background = 'rgba(30, 30, 46, 0.9)';
  notification.style.color = '#fff';
  notification.style.padding = '10px 20px';
  notification.style.borderRadius = '8px';
  notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.2)';
  notification.style.zIndex = '10000';
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transition = 'opacity 0.5s ease';
    setTimeout(() => {
      notification.remove();
    }, 500);
  }, 3000);
}

function updateParticipantsList() {
  participantsList.innerHTML = '';
  participantsData.forEach(participant => {
    const li = document.createElement('div');
    li.style.padding = '10px';
    li.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
    li.style.display = 'flex';
    li.style.alignItems = 'center';
    li.style.gap = '10px';
    
    const nameSpan = document.createElement('span');
    nameSpan.textContent = participant.displayName + (participant.isLocal ? ' (You)' : '');
    
    if (participant.handRaised) {
      const handIcon = document.createElement('i');
      handIcon.className = 'fas fa-hand-point-up';
      handIcon.style.color = '#6366f1';
      li.appendChild(handIcon);
    }
    
    li.appendChild(nameSpan);
    
    if (!participant.isLocal) {
      const kickBtn = document.createElement('button');
      kickBtn.innerHTML = '<i class="fas fa-user-slash"></i>';
      kickBtn.style.marginLeft = 'auto';
      kickBtn.style.background = 'none';
      kickBtn.style.border = 'none';
      kickBtn.style.color = '#ef4444';
      kickBtn.style.cursor = 'pointer';
      kickBtn.onclick = () => {
        if (confirm(`Kick ${participant.displayName}?`)) {
          api.executeCommand('kickParticipant', participant.id);
        }
      };
      li.appendChild(kickBtn);
    }
    
    participantsList.appendChild(li);
  });
  
  participantsCount.textContent = participantsData.length;
}

function sendMessage() {
  const message = chatInput.value.trim();
  if (message) {
    api.executeCommand('sendChatMessage', message);
    chatInput.value = '';
  }
}

function addMessageToChat(sender, message, isSelf) {
  const messageElement = document.createElement('div');
  messageElement.style.padding = '10px';
  messageElement.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
  messageElement.style.display = 'flex';
  messageElement.style.flexDirection = 'column';
  messageElement.style.alignItems = isSelf ? 'flex-end' : 'flex-start';
  
  const senderSpan = document.createElement('span');
  senderSpan.style.fontWeight = '500';
  senderSpan.style.color = isSelf ? '#6366f1' : '#fff';
  senderSpan.textContent = isSelf ? 'You' : sender;
  
  const messageSpan = document.createElement('span');
  messageSpan.style.background = isSelf ? 'rgba(99, 102, 241, 0.2)' : 'rgba(255, 255, 255, 0.1)';
  messageSpan.style.padding = '8px 12px';
  messageSpan.style.borderRadius = '8px';
  messageSpan.style.marginTop = '4px';
  messageSpan.textContent = message;
  
  messageElement.appendChild(senderSpan);
  messageElement.appendChild(messageSpan);
  chatMessages.appendChild(messageElement);
  
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Search Participants
searchParticipants.addEventListener('input', function () {
  const searchTerm = this.value.toLowerCase();
  participantsList.innerHTML = '';
  
  participantsData
    .filter(p => p.displayName.toLowerCase().includes(searchTerm))
    .forEach(participant => {
      const li = document.createElement('div');
      li.style.padding = '10px';
      li.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
      li.style.display = 'flex';
      li.style.alignItems = 'center';
      li.style.gap = '10px';
      
      const nameSpan = document.createElement('span');
      nameSpan.textContent = participant.displayName + (participant.isLocal ? ' (You)' : '');
      
      if (participant.handRaised) {
        const handIcon = document.createElement('i');
        handIcon.className = 'fas fa-hand-point-up';
        handIcon.style.color = '#6366f1';
        li.appendChild(handIcon);
      }
      
      li.appendChild(nameSpan);
      
      if (!participant.isLocal) {
        const kickBtn = document.createElement('button');
        kickBtn.innerHTML = '<i class="fas fa-user-slash"></i>';
        kickBtn.style.marginLeft = 'auto';
        kickBtn.style.background = 'none';
        kickBtn.style.border = 'none';
        kickBtn.style.color = '#ef4444';
        kickBtn.style.cursor = 'pointer';
        kickBtn.onclick = () => {
          if (confirm(`Kick ${participant.displayName}?`)) {
            api.executeCommand('kickParticipant', participant.id);
          }
        };
        li.appendChild(kickBtn);
      }
      
      participantsList.appendChild(li);
    });
});

// Initialize Jitsi on page load
initJitsi();
  </script>
</body>
</html>